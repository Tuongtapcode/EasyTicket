{% extends 'layout/base.html' %}
{% block content %}

<style>
  /* --- Search hero --- */
  .search-hero {
    background: linear-gradient(135deg,#7140ff 0%, #9a54ff 45%, #22c1c3 100%);
    padding: 48px 0 64px;
  }
  .search-card {
    background: rgba(255,255,255,.92);
    box-shadow: 0 12px 30px rgba(23,26,31,.12);
    border: 0; border-radius: 20px;
  }
  .search-card .form-control-lg { padding: .9rem 1.1rem; }

  /* --- Chips (event types) --- */
  .chips-wrap {
    gap: .5rem; flex-wrap: wrap; overflow-x: auto;
    scrollbar-width: none;
  }
  .chips-wrap::-webkit-scrollbar { display:none; }
  .chip {
    border-radius: 999px; padding: .35rem .9rem; font-weight: 600;
    border: 1px solid #cfd7ff; color: #3b4cca; background: #f6f8ff;
    transition: all .15s ease;
    white-space: nowrap;
  }
  .chip:hover { background: #edf2ff; }
  .chip.active { background: #3b4cca; color: #fff; border-color: #3b4cca; }

  /* --- Cards --- */
  .card-hover { transition: transform .15s ease, box-shadow .15s ease; }
  .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(18,18,18,.12); }

  .event-banner {
    height: 180px; border-radius: 12px 12px 0 0;
    background: linear-gradient(135deg,#7f6dff 0%, #6ad8ff 100%);
    display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:44px;
  }
  .status-badge {
    position:absolute; top:10px; right:10px;
  }
</style>

<section class="search-hero">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card search-card p-4 p-md-5">
          <h2 class="h4 text-center mb-4">
            <i class="fas fa-search me-2"></i>Tìm kiếm sự kiện yêu thích
          </h2>

          <form class="row g-3" method="get" action="{{ url_for('event.search') }}" id="searchForm">
            <div class="col-md-10">
              <input type="text" class="form-control form-control-lg" id="searchInput" name="q"
                     placeholder="Tìm theo tên / mô tả / địa điểm…">
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary w-100" type="submit">
                <i class="fas fa-search me-2"></i>Tìm kiếm
              </button>
            </div>
          </form>

          <!--Event Types, có gắn id nên sẽ tạo sự kiện lắng nghe luôn-->
          <div class="mt-4 d-flex chips-wrap" id="eventTypeChips">
            <button type="button" class="chip active" data-type-id="" aria-pressed="true">Tất cả</button>
            {% for t in events_type %}
              <button type="button" class="chip" data-type-id="{{ t.id }}">{{ t.name }}</button>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- =========== Content =========== -->
<section class="py-5">
  <div class="container">
    <div class="row">
      <div class="col-lg-3">
        <div class="filter-sidebar">
          <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Bộ lọc</h5>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">Danh sách sự kiện</h3>
          <div class="d-flex align-items-center">
            <span class="me-3 text-muted">Sắp xếp:</span>
            <select class="form-select" id="sortSelect" style="width:auto;">
              <option value="newest">Mới nhất</option>
              <option value="oldest">Cũ nhất</option>
              <option value="price-low">Giá thấp đến cao</option>
              <option value="price-high">Giá cao đến thấp</option>
              <option value="name">Tên A-Z</option>
            </select>
          </div>
        </div>

        <div id="eventsGrid" class="row g-4"></div>

        <div id="noResults" class="no-events d-none text-center py-5">
          <i class="fas fa-calendar-times fa-4x mb-3 text-muted"></i>
          <h4>Không tìm thấy sự kiện nào</h4>
          <p class="text-muted">Hãy thử thay đổi tiêu chí tìm kiếm hoặc bộ lọc</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // ====== DỮ LIỆU SỰ KIỆN ======
  const events = [
    {% for e in events %}
    {
      id: {{ e.id|tojson }},
      name: {{ (e.name or '')|tojson }},
      description: {{ (e.description or '')|tojson }},
      status: {{ ((e.status.name) if e.status else 'PUBLISHED')|tojson }},
      start_datetime: {{ (e.start_datetime.isoformat() if e.start_datetime else '')|tojson }},
      end_datetime: {{ (e.end_datetime.isoformat() if e.end_datetime else '')|tojson }},
      address: {{ (e.address or '')|tojson }},
      category: {{ ((e.category.name) if e.category is not none and e.category is not string else (e.category or ''))|tojson }},
      organizer: {{ (((e.organizer.first_name ~ ' ' ~ e.organizer.last_name).strip()) if e.organizer else '')|tojson }},
      created_at: {{ (e.created_at.isoformat() if e.created_at else '')|tojson }},
      event_type_id: {{ e.event_type_id|tojson }},
      event_type_name: {{ (e.event_type.name if e.event_type else '')|tojson }},
      ticketTypes: [
        {% for t in (e.ticket_types or []) %}
        { name: {{ (t.name or 'Vé thường')|tojson }}, price: {{ (t.price|string)|tojson }}, description: {{ (t.description or '')|tojson }}, quantity: {{ (t.quantity or 0)|int }} }
        {% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  let filteredEvents = [...events];

  function formatDate(s) {
    const d = new Date(s);
    return d.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }
  function getStatusBadge(status) {
    const map = {
      PUBLISHED: '<span class="badge bg-success status-badge">Đã xuất bản</span>',
      DRAFT:     '<span class="badge bg-warning status-badge">Bản nháp</span>',
      CANCELLED: '<span class="badge bg-danger status-badge">Đã hủy</span>',
      COMPLETED: '<span class="badge bg-secondary status-badge">Đã hoàn thành</span>'
    };
    return map[status] || '';
  }
  function formatPrice(p) { return (parseInt(p)||0).toLocaleString('vi-VN') + ' VNĐ'; }
  function getMinPrice(tt) {
    const prices = tt.map(t=>parseInt(t.price)).filter(p=>p>0);
    return prices.length ? Math.min(...prices) : 0;
  }
  function hasAvailableTickets(tt){ return tt.some(t=>t.quantity>0); }

  function renderEvents(list = filteredEvents) {
    const grid = document.getElementById('eventsGrid');
    const noRes = document.getElementById('noResults');
    if (!list.length) { grid.innerHTML = ''; noRes.classList.remove('d-none'); return; }
    noRes.classList.add('d-none');

    grid.innerHTML = list.map(event => `
      <div class="col-lg-4 col-md-6">
        <div class="card card-hover position-relative h-100" onclick="openEventDetail(${event.id})" style="cursor:pointer;">
          ${getStatusBadge(event.status)}
          <div class="event-banner"><i class="far fa-calendar"></i></div>
          <div class="card-body">
            <div class="small text-muted mb-1"><i class="fas fa-layer-group me-1"></i>${event.event_type_name || '—'}</div>
            <h5 class="card-title">${event.name}</h5>
            <p class="text-muted mb-2">${(event.description||'').substring(0, 80)}...</p>

            <div class="mb-1"><i class="fas fa-calendar-alt me-1"></i><small>${formatDate(event.start_datetime)}</small></div>
            <div class="mb-2"><i class="fas fa-location-dot me-1"></i><small>${event.address}</small></div>

            <div class="d-flex justify-content-between align-items-center">
              <div>${getMinPrice(event.ticketTypes) > 0
                ? `<span class="badge text-bg-light">Từ ${formatPrice(getMinPrice(event.ticketTypes))}</span>`
                : `<span class="badge text-bg-success">Miễn phí</span>`}</div>
              <div>${hasAvailableTickets(event.ticketTypes)
                ? `<span class="badge bg-success">Còn vé</span>`
                : `<span class="badge bg-danger">Hết vé</span>`}</div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function sortEvents() {
    const by = document.getElementById('sortSelect').value;
    filteredEvents.sort((a,b)=>{
      switch(by){
        case 'newest':     return new Date(b.created_at) - new Date(a.created_at);
        case 'oldest':     return new Date(a.created_at) - new Date(b.created_at);
        case 'price-low':  return getMinPrice(a.ticketTypes) - getMinPrice(b.ticketTypes);
        case 'price-high': return getMinPrice(b.ticketTypes) - getMinPrice(a.ticketTypes);
        case 'name':       return a.name.localeCompare(b.name);
        default:           return 0;
      }
    });
    renderEvents();
  }

  function openEventDetail(id){ window.location.href = `/events/${id}`; }

  // ---- chips behaviour (click → điều hướng sang trang search) ----
  function goType(typeId) {
    const base = "{{ url_for('event.search') }}";
    const url = typeId ? `${base}?event_type_id=${encodeURIComponent(typeId)}` : base;
    window.location.href = url;
  }

  document.addEventListener('DOMContentLoaded', () => {
    // render initial
    renderEvents();

    // search form: trim trước khi submit
    document.getElementById('searchForm').addEventListener('submit', (e)=>{
      const inp = document.getElementById('searchInput');
      inp.value = (inp.value||'').trim();
    });

    // sort
    document.getElementById('sortSelect').addEventListener('change', sortEvents);

    // chips click (đổi trạng thái & redirect)
    document.getElementById('eventTypeChips').addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      document.querySelectorAll('#eventTypeChips .chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      goType(chip.dataset.typeId || '');
    });
  });
</script>

{% endblock %}
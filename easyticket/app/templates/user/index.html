{% extends 'layout/base.html' %}
{% block content %}
  <!-- Header -->


    <!-- Search Section -->
    <section class="search-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="category-filter">
                        <h2 class="h4 text-center mb-4">
                            <i class="fas fa-search me-2"></i>Tìm kiếm sự kiện yêu thích
                        </h2>

                         <!-- Chỉ keyword: form GET -> /events?q=... -->
          <form class="row g-3" method="get" action="{{ url_for('event.search') }}" onsubmit="return submitSearch(event)">
            <div class="col-md-10">
              <input type="text"
                     class="form-control form-control-lg"
                     id="searchInput"
                     name="q"
                     placeholder="Tìm theo tên/mô tả/địa điểm...">
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary-custom w-100 text-white" type="submit">
                <i class="fas fa-search me-2"></i>Tìm kiếm
              </button>
            </div>
          </form>

                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select form-select-lg" id="statusFilter">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="PUBLISHED">Đã xuất bản</option>
                                    <option value="DRAFT">Bản nháp</option>
                                    <option value="CANCELLED">Đã hủy</option>
                                    <option value="COMPLETED">Đã hoàn thành</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-lg" id="categoryFilter">
                                    <option value="">Tất cả danh mục</option>
                                    <option value="music">Âm nhạc</option>
                                    <option value="tech">Công nghệ</option>
                                    <option value="art">Nghệ thuật</option>
                                    <option value="sports">Thể thao</option>
                                    <option value="food">Ẩm thực</option>
                                </select>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filter and Events Section -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <!-- Filter Sidebar -->
                <div class="col-lg-3">
                    <div class="filter-sidebar">
                        <h5 class="mb-3">
                            <i class="fas fa-filter me-2"></i>Bộ lọc
                        </h5>

                        <!-- Date Filter -->
                        <div class="mb-4">
                            <h6>Thời gian</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dateFilter" id="today" value="today">
                                <label class="form-check-label" for="today">Hôm nay</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dateFilter" id="tomorrow" value="tomorrow">
                                <label class="form-check-label" for="tomorrow">Ngày mai</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dateFilter" id="weekend" value="weekend">
                                <label class="form-check-label" for="weekend">Cuối tuần</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dateFilter" id="nextweek" value="nextweek">
                                <label class="form-check-label" for="nextweek">Tuần tới</label>
                            </div>
                        </div>

                        <!-- Price Filter -->
                        <div class="mb-4">
                            <h6>Khoảng giá</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="free" value="free">
                                <label class="form-check-label" for="free">Miễn phí</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="under500k" value="under500k">
                                <label class="form-check-label" for="under500k">Dưới 500k</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="500k-1m" value="500k-1m">
                                <label class="form-check-label" for="500k-1m">500k - 1M</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="over1m" value="over1m">
                                <label class="form-check-label" for="over1m">Trên 1M</label>
                            </div>
                        </div>

                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Xóa bộ lọc
                        </button>
                    </div>
                </div>

                <!-- Events Grid -->
                <div class="col-lg-9">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Danh sách sự kiện</h3>
                        <div class="d-flex align-items-center">
                            <span class="me-3 text-muted">Sắp xếp:</span>
                            <select class="form-select" id="sortSelect" style="width: auto;">
                                <option value="newest">Mới nhất</option>
                                <option value="oldest">Cũ nhất</option>
                                <option value="price-low">Giá thấp đến cao</option>
                                <option value="price-high">Giá cao đến thấp</option>
                                <option value="name">Tên A-Z</option>
                            </select>
                        </div>
                    </div>

                    <div id="eventsGrid" class="row g-4">
                        <!-- Events will be populated here -->
                    </div>

                    <!-- No Results -->
                    <div id="noResults" class="no-events d-none">
                        <i class="fas fa-calendar-times fa-4x mb-3"></i>
                        <h4>Không tìm thấy sự kiện nào</h4>
                        <p>Hãy thử thay đổi tiêu chí tìm kiếm hoặc bộ lọc</p>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-5">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Trước</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Event Detail Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modalBanner" class="event-banner rounded mb-4">
                        <i class="fas fa-calendar-alt"></i>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <h6><i class="fas fa-align-left me-2"></i>Mô tả sự kiện</h6>
                            <p id="modalDescription" class="mb-4"></p>

                            <h6><i class="fas fa-map-marker-alt me-2"></i>Địa điểm</h6>
                            <p id="modalAddress" class="mb-4"></p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-clock me-2"></i>Thời gian</h6>
                            <p><strong>Bắt đầu:</strong><br><span id="modalStartTime"></span></p>
                            <p><strong>Kết thúc:</strong><br><span id="modalEndTime"></span></p>
                        </div>
                    </div>

                    <h6><i class="fas fa-ticket-alt me-2"></i>Loại vé có sẵn</h6>
                    <div id="ticketTypes">
                        <!-- Ticket types will be populated here -->
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success" onclick="buyTicket()">
                        <i class="fas fa-shopping-cart me-2"></i>Mua vé ngay
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="shareEvent()">
                        <i class="fas fa-share me-2"></i>Chia sẻ
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
        // Sample events data based on the database schema
        const events = [
  {% for e in events %}
  {
    id: {{ e.id|tojson }},
    name: {{ (e.name or '')|tojson }},
    description: {{ (e.description or '')|tojson }},

    // Lưu ý: e.status là Enum -> lấy .name (fallback 'PUBLISHED')
    status: {{ ((e.status.name) if e.status else 'PUBLISHED')|tojson }},

    start_datetime: {{ (e.start_datetime.isoformat() if e.start_datetime else '')|tojson }},
    end_datetime: {{ (e.end_datetime.isoformat() if e.end_datetime else '')|tojson }},
    address: {{ (e.address or '')|tojson }},

    // Nếu category cũng là Enum -> lấy .name, còn không thì giữ string
    category: {{ ((e.category.name) if e.category is not none and e.category is not string else (e.category or ''))|tojson }},

    organizer: {{ (
        ((e.organizer.first_name ~ ' ' ~ e.organizer.last_name).strip())
        if e.organizer else ''
    )|tojson }},
    created_at: {{ (e.created_at.isoformat() if e.created_at else '')|tojson }},

    // ticketTypes luôn là mảng (có thể rỗng)
    ticketTypes: [
      {% for t in (e.ticket_types or []) %}
      {
        name: {{ (t.name or 'Vé thường')|tojson }},
        // Để dạng chuỗi để parseInt trong JS hoạt động như cũ
        price: {{ (t.price|string)|tojson }},
        description: {{ (t.description or '')|tojson }},
        quantity: {{ (t.quantity or 0)|int }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

        let filteredEvents = [...events];
        let currentEvent = null;

        // Format date function
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'PUBLISHED': '<span class="badge bg-success position-absolute status-badge">Đã xuất bản</span>',
                'DRAFT': '<span class="badge bg-warning position-absolute status-badge">Bản nháp</span>',
                'CANCELLED': '<span class="badge bg-danger position-absolute status-badge">Đã hủy</span>',
                'COMPLETED': '<span class="badge bg-secondary position-absolute status-badge">Đã hoàn thành</span>'
            };
            return badges[status] || '';
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'music': 'fas fa-music',
                'tech': 'fas fa-laptop-code',
                'art': 'fas fa-palette',
                'sports': 'fas fa-running',
                'food': 'fas fa-utensils'
            };
            return icons[category] || 'fas fa-calendar';
        }

        // Format price
        function formatPrice(price) {
            return parseInt(price).toLocaleString('vi-VN') + ' VNĐ';
        }

        // Get minimum price for event
        function getMinPrice(ticketTypes) {
            const prices = ticketTypes.map(t => parseInt(t.price)).filter(p => p > 0);
            return prices.length > 0 ? Math.min(...prices) : 0;
        }

        // Check if event has available tickets
        function hasAvailableTickets(ticketTypes) {
            return ticketTypes.some(t => t.quantity > 0);
        }

        // Render events
        function renderEvents(eventsToRender = filteredEvents) {
            const grid = document.getElementById('eventsGrid');
            const noResults = document.getElementById('noResults');

            if (eventsToRender.length === 0) {
                grid.innerHTML = '';
                noResults.classList.remove('d-none');
                return;
            }

            noResults.classList.add('d-none');

            grid.innerHTML = eventsToRender.map(event => `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card card-hover h-100 position-relative" onclick="openEventDetail(${event.id})" style="cursor: pointer;">
                        ${getStatusBadge(event.status)}
                        <div class="event-banner">
                            <i class="${getCategoryIcon(event.category)}"></i>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${event.name}</h5>
                            <p class="card-text text-muted">${event.description.substring(0, 100)}...</p>

                            <div class="event-info-item">
                                <i class="fas fa-calendar-alt"></i>
                                <small>${formatDate(event.start_datetime)}</small>
                            </div>
                            <div class="event-info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <small>${event.address}</small>
                            </div>
                            <div class="event-info-item">
                                <i class="fas fa-user"></i>
                                <small>Bởi ${event.organizer}</small>
                            </div>
                            <div class="event-info-item">
                                <i class="fas fa-ticket-alt"></i>
                                <small>${event.ticketTypes.length} loại vé</small>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    ${getMinPrice(event.ticketTypes) > 0 ?
                                        `<span class="price-range">Từ ${formatPrice(getMinPrice(event.ticketTypes).toString())}</span>` :
                                        `<span class="price-range text-success">Miễn phí</span>`
                                    }
                                </div>
                                <div>
                                    ${hasAvailableTickets(event.ticketTypes) ?
                                        `<span class="badge bg-success">Còn vé</span>` :
                                        `<span class="badge bg-danger">Hết vé</span>`
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-primary-custom w-100">
                                <i class="fas fa-eye me-2"></i>Xem chi tiết
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Search and filter events
        function searchEvents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredEvents = events.filter(event => {
                const matchesSearch = event.name.toLowerCase().includes(searchTerm) ||
                                    event.description.toLowerCase().includes(searchTerm) ||
                                    event.organizer.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || event.status === statusFilter;
                const matchesCategory = !categoryFilter || event.category === categoryFilter;

                return matchesSearch && matchesStatus && matchesCategory;
            });

            renderEvents(filteredEvents);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('sortSelect').value = 'newest';

            // Clear radio buttons and checkboxes
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.checked = false;
            });

            filteredEvents = [...events];
            renderEvents(filteredEvents);
        }

        // Sort events
        function sortEvents() {
            const sortBy = document.getElementById('sortSelect').value;

            filteredEvents.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'price-low':
                        return getMinPrice(a.ticketTypes) - getMinPrice(b.ticketTypes);
                    case 'price-high':
                        return getMinPrice(b.ticketTypes) - getMinPrice(a.ticketTypes);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    default:
                        return 0;
                }
            });

            renderEvents(filteredEvents);
        }

        // Open event detail modal
        function openEventDetail(eventId) {
             window.location.href = `/events/${eventId}`;
        }

        // Buy ticket function
        function buyTicket() {
            if (currentEvent.status !== 'PUBLISHED') {
                alert('Sự kiện này chưa được xuất bản hoặc đã bị hủy!');
                return;
            }

            if (!hasAvailableTickets(currentEvent.ticketTypes)) {
                alert('Rất tiếc, sự kiện này đã hết vé!');
                return;
            }

            // Close modal and show success message
            const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
            modal.hide();

            alert('Chức năng mua vé sẽ được triển khai trong phiên bản tiếp theo!');
        }

        // Share event function
        function shareEvent() {
            if (navigator.share) {
                navigator.share({
                    title: currentEvent.name,
                    text: currentEvent.description,
                    url: window.location.href + '#event-' + currentEvent.id
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                const url = window.location.href + '#event-' + currentEvent.id;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Đã sao chép link sự kiện vào clipboard!');
                });
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', searchEvents);

            // Filter selects
            document.getElementById('statusFilter').addEventListener('change', searchEvents);
            document.getElementById('categoryFilter').addEventListener('change', searchEvents);

            // Sort select
            document.getElementById('sortSelect').addEventListener('change', sortEvents);

            // Filter checkboxes and radio buttons
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', searchEvents);
            });

            // Initialize
            renderEvents();
        });

         function submitSearch(e) {
    // Cho phép submit form bình thường (GET q=...)
    // nhưng cũng chuẩn hoá khoảng trắng/trim nếu muốn
    const input = document.getElementById('searchInput');
    input.value = (input.value || '').trim();
    // có thể return true để form submit; hoặc redirect thủ công:
    // window.location.href = "{{ url_for('event.search') }}?q=" + encodeURIComponent(input.value);
    return true;
  }

        // Add search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEvents();
            }
        });
    </script>
{% endblock %}